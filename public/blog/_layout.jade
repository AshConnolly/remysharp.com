extends ../_partials/layout

block meta
  - var summary = null
  if yield.split(/<!--\s*more\s*-->/).length > 1
    - summary = yield.split(/<!--\s*more\s*-->/)[0].replace(/<h1>.*?<\/h1>/, '').trim()
  else if yield.split('<hr>').length > 1
    - summary = yield.split('<hr>')[0].replace(/<h1>.*?<\/h1>/, '').trim()
  else
    - summary = yield.split('<p>').slice(0, 4).join('<p>').replace(/<h1>.*?<\/h1>/, '').trim()
  if summary
    - summary = '<meta name="twitter:description" content="' + summary.replace(/<(?:.|\n)*?>/gm, '') + '">';
    != summary
  meta(name="twitter:creator" content="@rem")
  meta(name="twitter:title" content="#{title}")
  meta(name="twitter:site" content="@rem")
  meta(name="twitter:domain" content="Remy's b:log")
  - var img = image;
  - if (!img && yield.indexOf('<img') !== -1) img = (yield.replace(/\n/g, '').match(/<img\b[^>]+?src\s*=\s*['"]?([^\s'"?#>]+)/) || [,])[1];
  - if (img && img.indexOf('http') !== 0) img = site_url + img;
  if img
    meta(name="twitter:image:src" content="#{img}")
    meta(name="twitter:card" content="summary_large_image")
  else
    meta(name="twitter:card" content="summary")

block content
  - permalink = '/' + moment(date).format('YYYY/MM/DD') + '/' + current.source;
  - safeTitle = title.replace(/'/g, '\\\'')

  != partial('../_partials/post-nav')

  main.content(role="main")
    article.post
      h1.title
        a(href="#{permalink}" rel="bookmark" title="Permanent Link: #{title}")= title

      small.edit: a(href="https://github.com/remy/remysharp.com/blob/master/public/blog/#{current.source}.md") (edit)
      .post-content
        //- strip the h1 out of the body as we printed it above as the permalink
        - if (yield) yield = yield.replace(/<h1>.*?<\/h1>/, '');
        != yield

        p
          small Posted #{moment(date).format('D-MMM YYYY')} under #{tags.join(' & ')}.

        footer.follow
          .row
            .c4.s1
              img#avatar(src="/images/avatar-300.png" width="150")
            .c4.s3
              h3 <span id="iam">I am</span> Remy Sharp
              <a href="https://twitter.com/rem" class="twitter-follow-button" data-show-count="true">Follow @rem</a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
              :marked
                I'm a JavaScript developer working professionally on the web since 1999. I run my own [consultancy](/work), build products, run training, speak at conferences and curate the UK's best [JavaScript event](https://ffconf.org).
              //- p Posted #{moment(date).format('D-MMM YYYY')} under #{tags.join(' & ')}. <span class="note">Find me on Twitter <a href="http://twitter.com/rem">here</a> I'll tweet about JavaScript, HTML5 and other such gems (amongst usual tweet-splurges).</span><!--<br>ðŸ“š Read more: the <a href="/latest">latest</a> post or a <a href="/random">random</a> post.-->
          form.row(action="//remysharp.us13.list-manage.com/subscribe/post?u=c3ac6dd00a3b2269a6634560c&amp;id=56328dedcb" method="post" target="_blank" novalidate)#subscribe-form
            h3 Subscribe
            p Posts, web tech insights, exclusive workshop and training discounts and more, direct to your inbox.
            .row
              input(type="email" placeholder="Email Address" value="" name="EMAIL" class="required email")
              input(type="submit" value="Sign up" name="subscribe" class="button")
              div(style="position: absolute; left: -5000px;" aria-hidden="true")
                input(type="text" name="b_c3ac6dd00a3b2269a6634560c_56328dedcb" tabindex="-1" value="")

      if environment == "production"
        .comments
          h2 Comments
          #disqus_thread
          script.
            var disqus_shortname = 'remysharp';
            var disqus_url = 'http://remysharp.com#{permalink}/';
            var disqus_title = '#{safeTitle}';
          //- noscript Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
          //- a.dsq-brlink(href="http://disqus.com") comments powered by <span class="logo-disqus">Disqus</span></a>
