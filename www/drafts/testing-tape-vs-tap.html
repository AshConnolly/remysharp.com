<!DOCTYPE html PUBLIC "Uncompressed source: https://github.com/remy/remysharp.com"><html id="remysharp-com"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Testing: tape vs. tap</title><meta name="description" content="Testing: tape vs. tap"/><meta name="HandheldFriendly" content="True"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/favicon.ico"/><link rel="stylesheet" type="text/css" href="/css/screen.css?2.34"/><link rel="stylesheet" type="text/css" href="/css/zenburn.css?2.34"/><link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://feeds.feedburner.com/remysharp"/><link rel="alternate" type="text/xml" title="RSS .92" href="http://feeds.feedburner.com/remysharp"/><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="http://feeds.feedburner.com/remysharp"/><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-1656750-1', 'auto');
ga('send', 'pageview');</script></head><body id="drafts-testing-tape-vs-tap-page"><nav class="main-nav clearfix subpanel"><form action="/search" class="search"><input type="text" name="q" placeholder="Search for..."/><input type="submit" value="Search"/></form><ul class="post-nav"><li class="home"><a href="/">Home</a></li><li class="search"><a id="search" href="#search">Search</a></li><li class="donate"><p><a href="https://www.paypal.me/rem"><img src="/images/donate.svg" alt="keep me honest"></a></p>
</li><li class="next"><a href="/2016/01/28/fixing-fixtures" title="Fixing fixtures">Latest post</a></li></ul></nav><main role="main" class="content"><div class="warning">Draft posts are a work in progress.&nbsp;Last edited 1-Jan 1970</div><article class="post"><h1 class="title"><a href="/drafts/testing-tape-vs-tap">Testing: tape vs. tap</a><small class="edit"><a href="https://github.com/remy/remysharp.com/blob/master/public/drafts/testing-tape-vs-tap.md">(edit)</a></small></h1><div class="post-content"><p>I recently wrote about my <a href="https://remysharp.com/2015/12/14/my-node-test-strategy">node test strategy</a> and in particular talked about using <a href="https://npmjs.org/tape">tape</a> as my test runner and piping to <a href="https://www.npmjs.com/package/tap-spec">tap-spec</a>.</p>
<p>I&#39;ve since started to migrate across to <a href="https://www.npmjs.com/package/tap">tap</a> exclusively for both the runner and the reporter.</p>
<!--more-->
<p>There&#39;s a couple of benefits to my workflow in using tap for the tests. Partly the reduced dependencies (so less tracking for changes and less knowledge required), but also the reporting is much more valuable to me, as I&#39;ll show you below.</p>
<h2>Tracing errors</h2><p>Below is the output, with an error inside my tested code whilst using tape as my runner and executing through tap:</p>
<p><img src="/images/tape-vs-tap-1.png" alt="tape error output"></p>
<p>As you can see from the output above, there&#39;s an exception and it&#39;s failing the test, but there&#39;s very little information about <em>where</em> it failed. I can see it was inside a promise, but since a lot of my code is based around promises, including the test itself, there&#39;s essentially no stacktrace at all.</p>
<p>To switch my code from using the tape library to tap, I only need to change the require line from:</p>
<pre><code class="language-js">var test = require(&#39;tape&#39;);
</code></pre>
<p>...to...</p>
<pre><code class="language-js">var test = require(&#39;tap&#39;).test;
</code></pre>
<p>The rest of my test code can remain the same, as the API for tape is generally a subset of tap&#39;s own assert API. The output now changes to give a better idea of the stacktrace:</p>
<p><img src="/images/tape-vs-tap-2.png" alt="tap error output"></p>
<p>But this still doesn&#39;t quite give me enough detail. I can see exactly where the error is being thrown, but this is in my test code. I need to hook in the stack into my test. The following code shows how the error was being displayed (from the screenshot above):</p>
<pre><code class="language-js">auth().then(function (res) {
  t.notEqual(res, -1, &#39;auth worked&#39;);
}).catch(function (e) {
  t.fail(e);
});
</code></pre>
<p>Instead of using <code>t.fail</code> and passing the error directly in, I switch to using <code>t.threw</code> which works nicely with my promise code and will give me a full stacktrace. A side benefit is that I can also avoid using a <code>plan</code>so long as my promise has a final <code>.then(t.end)</code> to notify that the tests are complete:</p>
<pre><code class="language-js">auth().then(function (res) {
  t.notEqual(res, -1, &#39;auth worked&#39;);
}).catch(t.threw).then(t.end);
</code></pre>
<p>Now the failing test has much more detail:</p>
<p><img src="/images/tape-vs-tap-3.png" alt="tap error output"></p>
<p>I have the full stacktrace from the origin of the error and I can fix the issue.</p>
<h2>Visual deltas</h2><p>Finally it&#39;s also worth showing the other big benefit to me, specifically around failing <code>deepEqual</code> tests. In some of my integration tests, I&#39;ll create a fixture that&#39;s a JSON object the expected result.</p>
<p>If there&#39;s an error and the result is different to my fixture, the tape result doesn&#39;t always help understand where the issue is. As you can see below, the object has been dumped out without any real clue as to <em>where</em> the issue is:</p>
<p><img src="/images/tape-vs-tap-4.png" alt="tape diff output"></p>
<p>However, using tap as my required test library, automatically gives me a visual cue on the delta between my fixture and my actual output:</p>
<p><img src="/images/tape-vs-tap-5.png" alt="tap diff output"></p>
<p>Immediately, I can see the timestamp is the problem and it&#39;s simple for me to then go and either fix the code or change the test.</p>
<h2>Coverage reporting for free</h2><p>Finally, tap comes with coverage reporting built in. For local testing, I include the following in my <code>package.json</code> so I can browse the interactive coverage report:</p>
<pre><code class="language-json">&quot;scripts&quot;: {
  &quot;cover&quot;: &quot;tap test/*.test.js --cov --coverage-report=lcov&quot;,
</code></pre>
<p>This generates the <a href="https://gotwarlost.github.io/istanbul/">istanbul</a> coverage report that I open up immediately and see either where I&#39;m missing coverage, or where I can identify dead code.</p>
<p>In addition, since I publish to Travis for my tests, it will post automatically to tools like <a href="https://coveralls.io/">coveralls.io</a> and I&#39;m able to share the coverage either with the public or with my team internally. Note there&#39;s a few specific environment values you need to get coverage working (specific to Coveralls):</p>
<ol>
<li>Add your coveralls token under <code>COVERALLS_REPO_TOKEN</code></li>
<li>If you&#39;ve got a private repo, use <code>COVERALLS_SERVICE_NAME=travis-pro</code> (you don&#39;t need this for public repos)</li>
<li>If you&#39;re using more than one test in your test matrix (i.e. testing node 0.10, 4 and 5) include <code>COVERALLS_PARALLEL=true</code></li>
</ol>
<p>And that&#39;s it. These are the reasons I&#39;m using tap now over tape, and so far, it&#39;s all proving really valuable. My next post on testing, I&#39;ll explain how I debug and fix failing tests in (as close to) real-time as possible.</p><p class="update">Drafts may be incomplete or entirely abandonded, so please forgive me. If you find an issue with a draft, or would like to see me write about something specifically, please try <a href="http://github.com/remy/remysharp.com/issues/new">raising an issue</a>.</p></div></article></main><footer class="site-footer clearfix flex subpanel"><div class="flex-item archives"><h2>Archives</h2><ul><li><a href="/archive">All years</a></li><li><a href="/2016">2016</a></li><li><a href="/2015">2015</a></li><li><a href="/2014">2014</a></li><li><a href="/2013">2013</a></li><li><a href="/2012">2012</a></li><li><a href="/2011">2011</a></li><li><a href="/2010">2010</a></li><li><a href="/2009">2009</a></li><li><a href="/2008">2008</a></li><li><a href="/2007">2007</a></li><li><a href="/2006">2006</a></li></ul></div><div class="flex-item links"><h2>Links</h2><ul><li><a href="/about">About Remy</a></li><li><a href="/ethos">Ethos (WIP)</a></li><li><a target="_blank" href="/feed.xml">RSS feed</a></li><li><a href="/search">Search</a></li><li><a target="_blank" href="https://github.com/remy">On GitHub</a></li><li><a target="_blank" href="https://twitter.com/rem">On Twitter</a></li><li><a target="_blank" href="http://lanyrd.com/profile/rem/past/speaking/">Presentations</a></li><li><a href="/house-rules">House Rules</a></li></ul></div><div class="flex-item license"><h2>License</h2><p class="vcard">All content by <a class="url fn" href="https://remysharp.com">Remy Sharp</a> and under <a href="http://creativecommons.org/licenses/by-nc-sa/2.0/uk/">creative commons</a> and code under <a href="http://rem.mit-license.org">MIT&nbsp;license</a>.</p><p>All code and content for this blog is available as <a href="https://github.com/remy/remysharp.com">open source on GitHub</a>.</p>
<p><a href="https://www.paypal.me/rem"><img src="/images/donate-hotpink.svg" alt="keep me honest"></a></p>
</div></footer><script src="//code.jquery.com/jquery-1.11.1.min.js"></script><script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script><script src="/js/jquery.fitvids.js"></script><script src="/js/highlight.min.js"></script><script src="/js/permalink.js?2.34"></script><script src="/js/index.js?2.34"></script><!--|  
|  
|  Carved up by hand using Harp and a shit load of hacking.
|  
|  Also, this:
|  
|  
|  
|                        \_            /;              _.._
|                        `\~--.._     //'            ,(+=\\\\
|                         `//////\  \\/;'             /~ (\\\\
|                           ~/////\~\`)'             /;   ))))
|                               `~'  |              ((`~/((((\
|                               ;'_\'\             /'))   )))))
|                              /~/ '" "'     _.  /'/\_ /^\`((( \
|                             `\/'       _.-~/--/ (  =(   | ,  |
|                                     _/~\_)_}___/^\/~`\.__\|==|
|                                    /uUUU)        )        |  |
|                                   (   / |      _-=o|\__ /'/~ \
|                                   ' /'  |     /(((((\`\(  |~\/
|                                   /'    |   /' )))))"`\`\|/_/---.._,$$,
|                             .,ssS$$$Sss|._/_..-((('    )\)>>>      ~\$
|                          ,sS$$$$$$$$$$$|$$$$$$$  |/    //'~`o        `\
|                        ,$$$$$$$$$$$$$$|$$S$$$$'  (    /                \
|                      ,$$$$$$$$$$$$S$$|$$$$$$$'   |   /              ,s$$$
|                    s$$$$$S$$$$$$$$$S|$$$$$$$$    |  /              $$$$$$
|                  _~,$S""''     ``"S|$$S$$$$$"    (_,`\,          ,$$$$$$$;
|                /~ ,"'             / 'S$$$$$"      \_./|        s$$$$$$$$$$
|             (~'      _,  \==~~)  /     """         \  |       $$$$$$$$$$$$
|              (0\   /0/     \-' /'                   \ |  |  ,$$$$$$$$$$$$$,
|              `/'  '         _-~                     |= \_-\ $$$$$$$$$$$$$$s
|              (~~~)      _.-~_-   \             \  ,s|= |   `"$$$$$$$$$$$$$$$
|             ( `-'  )/>-~  _/-__   |            |,$$$|_/,      `"$$$$$$$$$$$$
|             /V^^^^V~/' _/~/~~  ~~-|            |$$$$$$$$         "$$$$$$$$$$,
|            /  (^^^^),/' /'        )           /S$$$$$$$;         ,$$$$$$$$$$$,
|          ,$$_  `~~~'.,/'         /     _-ss, /(/-(/-(/'        ,s$$$$$$$$$$$$$
|        ,s$$$$$ssSS$$$'         ,$'.s$$$$$$$$'                  (/-(/-(/-(/-(/'
|       S$$$$$$$$$$$$$$        ,$$$$$$$$$$$$$'
|      (/-(/-(/-(/-(/'      _s$$$$$$$$$$$$$$
|                          (/-(/-(/-(/-(/-'
|  
|  
|  
|      – Remy
|  
|  --><!-- Env: production - static files--></body></html>